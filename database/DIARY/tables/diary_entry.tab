CREATE TABLE diary_entry (
   entry_id   NUMBER
    GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE NOKEEP NOSCALE NOT NULL ENABLE
  ,entry_date DATE NOT NULL ENABLE
  ,title      VARCHAR2(200) NOT NULL ENABLE
  ,body       CLOB NOT NULL ENABLE
  ,visibility VARCHAR2(10) DEFAULT 'PRIVATE' NOT NULL ENABLE
  ,status     VARCHAR2(10) DEFAULT 'DRAFT' NOT NULL ENABLE
  ,mood       VARCHAR2(20)
  ,location   VARCHAR2(200)
  ,created_on TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL ENABLE
  ,created_by VARCHAR2(128) DEFAULT COALESCE(
     SYS_CONTEXT('APEX$SESSION','APP_USER')
   ,SYS_CONTEXT('USERENV','SESSION_USER')
  ) NOT NULL ENABLE
  ,updated_on TIMESTAMP(6)
  ,updated_by VARCHAR2(128)
  ,CHECK ( VISIBILITY IN ( 'PUBLIC','PRIVATE' ) ) ENABLE
  ,CHECK ( STATUS IN ( 'DRAFT','PUBLISHED' ) ) ENABLE
  ,PRIMARY KEY ( entry_id )
    USING INDEX ENABLE
);

--INDEXES

CREATE UNIQUE INDEX sys_c0013597 ON diary_entry (entry_id);

CREATE INDEX diary_entry_nk1 ON diary_entry (entry_date);

CREATE INDEX diary_entry_nk2 ON diary_entry (UPPER(title));

--REFERENTIAL CONSTRAINTS

--COMMENTS

COMMENT ON COLUMN diary_entry.entry_date IS 'Logical date of the entry (shown in Calendar).';
COMMENT ON COLUMN diary_entry.body IS 'Full text (CLOB).';
COMMENT ON TABLE diary_entry  IS 'Diary entries (journal).';

--TRIGGERS

CREATE OR REPLACE TRIGGER diary_entry_biur
BEFORE INSERT OR UPDATE ON DIARY_ENTRY
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    IF :NEW.CREATED_ON IS NULL THEN
      :NEW.CREATED_ON := SYSTIMESTAMP;
    END IF;
    IF :NEW.CREATED_BY IS NULL THEN
      :NEW.CREATED_BY := COALESCE(
        SYS_CONTEXT('APEX$SESSION','APP_USER'),
        SYS_CONTEXT('USERENV','SESSION_USER')
      );
    END IF;
  END IF;

  IF UPDATING THEN
    :NEW.UPDATED_ON := SYSTIMESTAMP;
    :NEW.UPDATED_BY := COALESCE(
      SYS_CONTEXT('APEX$SESSION','APP_USER'),
      SYS_CONTEXT('USERENV','SESSION_USER')
    );
  END IF;
END;
/
ALTER TRIGGER diary_entry_biur ENABLE;

--GRANTS

--SYNONYMS
